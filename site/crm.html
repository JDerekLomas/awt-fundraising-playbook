<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Dashboard - AWT Playbook</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="mobile-menu-toggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="sidebar-overlay"></div>
    <nav class="sidebar">
        <div class="logo">
            <h2>AWT Playbook</h2>
            <p class="tagline">Fundraising Campaign</p>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="crm.html" class="active highlight-link">CRM</a></li>
            <li><a href="campaign.html">Campaign</a></li>
            <li><a href="quickstart.html">Start Tonight</a></li>
            <li><a href="socials.html">Social Media</a></li>
            <li><a href="contacts.html">Contact Database</a></li>
            <li><a href="prospects.html">Prospect Tracker</a></li>
            <li><a href="foundations.html">Foundations</a></li>
            <li><a href="corporate.html">Corporate</a></li>
            <li><a href="templates.html">Email Templates</a></li>
            <li><a href="strategy.html">Strategy</a></li>
            <li><a href="resources.html">Resources</a></li>
        </ul>

        <div class="campaign-goal">
            <h4>Campaign Goal</h4>
            <div class="progress-bar">
                <div class="progress" id="goal-progress" style="width: 0%"></div>
            </div>
            <p class="goal-text" id="goal-text">$0 / $500,000</p>
        </div>
    </nav>

    <main class="content">
        <header class="page-header">
            <h1>CRM Dashboard</h1>
            <p class="subtitle">Track relationships, log interactions, manage your pipeline</p>
        </header>

        <!-- Quick Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <span class="stat-value" id="stat-total">--</span>
                <span class="stat-label">Total Prospects</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="stat-pipeline">--</span>
                <span class="stat-label">Pipeline Value</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="stat-tasks">--</span>
                <span class="stat-label">Tasks Due</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="stat-stale">--</span>
                <span class="stat-label">Need Attention</span>
            </div>
        </div>

        <!-- Today's Actions -->
        <section class="card" id="today-section">
            <div class="card-header">
                <h2>Today's Actions</h2>
                <button class="btn btn-primary btn-sm" onclick="openQuickLog()">+ Log Interaction</button>
            </div>
            <div id="today-tasks">
                <p class="loading">Loading tasks...</p>
            </div>
        </section>

        <!-- Pipeline Kanban -->
        <section class="card mt-20">
            <div class="card-header">
                <h2>Pipeline</h2>
                <div class="pipeline-filters">
                    <select id="pipeline-filter" onchange="filterPipeline()">
                        <option value="all">All Categories</option>
                        <option value="individual">Individuals</option>
                        <option value="foundation">Foundations</option>
                        <option value="academic">Academic</option>
                    </select>
                </div>
            </div>
            <div class="pipeline-board" id="pipeline-board">
                <div class="pipeline-column" data-stage="prospect">
                    <div class="column-header">
                        <h3>Prospect</h3>
                        <span class="column-count" id="count-prospect">0</span>
                    </div>
                    <div class="column-value" id="value-prospect">$0</div>
                    <div class="column-cards" id="cards-prospect"></div>
                </div>
                <div class="pipeline-column" data-stage="contacted">
                    <div class="column-header">
                        <h3>Contacted</h3>
                        <span class="column-count" id="count-contacted">0</span>
                    </div>
                    <div class="column-value" id="value-contacted">$0</div>
                    <div class="column-cards" id="cards-contacted"></div>
                </div>
                <div class="pipeline-column" data-stage="meeting">
                    <div class="column-header">
                        <h3>Meeting</h3>
                        <span class="column-count" id="count-meeting">0</span>
                    </div>
                    <div class="column-value" id="value-meeting">$0</div>
                    <div class="column-cards" id="cards-meeting"></div>
                </div>
                <div class="pipeline-column" data-stage="proposal">
                    <div class="column-header">
                        <h3>Proposal</h3>
                        <span class="column-count" id="count-proposal">0</span>
                    </div>
                    <div class="column-value" id="value-proposal">$0</div>
                    <div class="column-cards" id="cards-proposal"></div>
                </div>
                <div class="pipeline-column" data-stage="committed">
                    <div class="column-header">
                        <h3>Committed</h3>
                        <span class="column-count" id="count-committed">0</span>
                    </div>
                    <div class="column-value" id="value-committed">$0</div>
                    <div class="column-cards" id="cards-committed"></div>
                </div>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="card mt-20">
            <div class="card-header">
                <h2>Recent Activity</h2>
            </div>
            <div id="recent-activity">
                <p class="loading">Loading activity...</p>
            </div>
        </section>
    </main>

    <!-- Quick Log Modal -->
    <div class="modal-overlay" id="quick-log-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Log Interaction</h2>
                <button class="modal-close" onclick="closeModal('quick-log-modal')">&times;</button>
            </div>
            <form id="quick-log-form">
                <div class="form-group">
                    <label>
                        Contact
                        <button type="button" class="info-btn" onclick="showInfo('contact')">?</button>
                    </label>
                    <div class="autocomplete-wrapper">
                        <input type="text"
                               class="form-input"
                               id="contact-input"
                               name="contact_name"
                               placeholder="Type name or select existing..."
                               autocomplete="off"
                               required>
                        <input type="hidden" name="contact_id" id="contact-id-hidden">
                        <div class="autocomplete-dropdown" id="contact-dropdown"></div>
                    </div>
                    <div class="info-tooltip" id="info-contact">
                        Start typing to search existing contacts, or enter a new name to create one. New contacts will be added to your pipeline automatically.
                    </div>
                </div>

                <!-- New Contact Fields (shown when creating new) -->
                <div id="new-contact-fields" style="display: none;">
                    <div class="new-contact-banner">
                        <span>‚ú® New contact - fill in details below</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                Email
                                <button type="button" class="info-btn" onclick="showInfo('email')">?</button>
                            </label>
                            <input type="email" class="form-input" name="new_email" placeholder="email@example.com">
                            <div class="info-tooltip" id="info-email">
                                Optional but recommended. Makes follow-up easier.
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                Twitter/X
                                <button type="button" class="info-btn" onclick="showInfo('twitter')">?</button>
                            </label>
                            <input type="text" class="form-input" name="new_twitter" placeholder="@handle">
                            <div class="info-tooltip" id="info-twitter">
                                Great for DM outreach. Include the @ symbol.
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Organization</label>
                            <input type="text" class="form-input" name="new_organization" placeholder="Company or affiliation">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-select" name="new_category">
                                <option value="individual">Individual</option>
                                <option value="foundation">Foundation</option>
                                <option value="corporate">Corporate</option>
                                <option value="academic">Academic</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            Estimated Gift Capacity
                            <button type="button" class="info-btn" onclick="showInfo('capacity')">?</button>
                        </label>
                        <select class="form-select" name="new_capacity">
                            <option value="5000">$1K - $10K</option>
                            <option value="25000">$10K - $50K</option>
                            <option value="75000">$50K - $100K</option>
                            <option value="150000">$100K+</option>
                        </select>
                        <div class="info-tooltip" id="info-capacity">
                            Your best guess based on their giving history, wealth indicators, or organization size. Can always update later.
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            Type
                            <button type="button" class="info-btn" onclick="showInfo('type')">?</button>
                        </label>
                        <select class="form-select" name="type" required>
                            <option value="email">Email</option>
                            <option value="call">Call</option>
                            <option value="meeting">Meeting</option>
                            <option value="social">Social (DM/Tweet)</option>
                            <option value="note">Note</option>
                        </select>
                        <div class="info-tooltip" id="info-type">
                            <strong>Email:</strong> Any email sent or received<br>
                            <strong>Call:</strong> Phone or video call<br>
                            <strong>Meeting:</strong> In-person or scheduled video<br>
                            <strong>Social:</strong> Twitter DM, LinkedIn message<br>
                            <strong>Note:</strong> Internal note (not outreach)
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            Outcome
                            <button type="button" class="info-btn" onclick="showInfo('outcome')">?</button>
                        </label>
                        <select class="form-select" name="outcome">
                            <option value="pending">Awaiting Response</option>
                            <option value="positive">Positive</option>
                            <option value="neutral">Neutral</option>
                            <option value="negative">Declined</option>
                        </select>
                        <div class="info-tooltip" id="info-outcome">
                            <strong>Awaiting:</strong> Just sent, no reply yet<br>
                            <strong>Positive:</strong> Good response, interest shown<br>
                            <strong>Neutral:</strong> Acknowledged but non-committal<br>
                            <strong>Declined:</strong> Said no (for now)
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        Notes
                        <button type="button" class="info-btn" onclick="showInfo('notes')">?</button>
                    </label>
                    <textarea class="form-textarea" name="notes" rows="3" placeholder="What happened? Key points, their response, next steps..."></textarea>
                    <div class="info-tooltip" id="info-notes">
                        Be specific! Future you will thank you. Include:<br>
                        ‚Ä¢ What you discussed<br>
                        ‚Ä¢ Their reaction/interest level<br>
                        ‚Ä¢ Any questions they asked<br>
                        ‚Ä¢ Promised follow-ups
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="create_followup" id="create-followup">
                        Create follow-up task
                    </label>
                </div>
                <div class="form-group followup-fields" style="display: none;">
                    <label>Follow-up in</label>
                    <select class="form-select" name="followup_days">
                        <option value="1">1 day</option>
                        <option value="3" selected>3 days</option>
                        <option value="7">1 week</option>
                        <option value="14">2 weeks</option>
                        <option value="30">1 month</option>
                    </select>
                </div>
                <div class="form-group" id="status-update-group">
                    <label>Update Status</label>
                    <select class="form-select" name="new_status">
                        <option value="">No change</option>
                        <option value="contacted">‚Üí Contacted</option>
                        <option value="meeting">‚Üí Meeting Scheduled</option>
                        <option value="proposal">‚Üí Proposal Sent</option>
                        <option value="committed">‚Üí Committed!</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" id="log-submit-btn">Log Interaction</button>
            </form>
        </div>
    </div>

    <!-- Contact Detail Modal -->
    <div class="modal-overlay" id="contact-detail-modal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 id="detail-name">Contact Name</h2>
                <button class="modal-close" onclick="closeModal('contact-detail-modal')">&times;</button>
            </div>
            <div class="contact-detail-content">
                <div class="detail-sidebar">
                    <div class="detail-info">
                        <p class="detail-org" id="detail-org"></p>
                        <p class="detail-amount" id="detail-amount"></p>
                        <div class="detail-links" id="detail-links"></div>
                    </div>
                    <div class="detail-hook" id="detail-hook"></div>
                    <div class="detail-approach" id="detail-approach"></div>
                    <div class="detail-actions">
                        <button class="btn btn-primary btn-block" onclick="logInteractionFor(currentContactId)">Log Interaction</button>
                        <button class="btn btn-secondary btn-block" onclick="createFollowupFor(currentContactId)">Add Follow-up</button>
                    </div>
                </div>
                <div class="detail-timeline">
                    <h3>Activity Timeline</h3>
                    <div id="detail-timeline-content">
                        <p class="empty-state">No interactions logged yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        let currentContactId = null;
        let allContacts = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDashboard();
            setupEventListeners();

            // Check for URL parameters (from Prospect Tracker links)
            const params = new URLSearchParams(window.location.search);
            const contactParam = params.get('contact');
            const logParam = params.get('log');

            if (contactParam) {
                // Open contact detail modal
                setTimeout(() => openContactDetail(contactParam), 300);
            } else if (logParam) {
                // Open log interaction modal for this contact
                const contact = allContacts.find(c => c.id === logParam);
                if (contact) {
                    document.getElementById('contact-input').value = contact.name;
                    document.getElementById('contact-id-hidden').value = logParam;
                    selectedContactId = logParam;
                    isNewContact = false;
                    setTimeout(() => openQuickLog(), 300);
                }
            }

            // Clear URL params after handling
            if (contactParam || logParam) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        async function loadDashboard() {
            try {
                // Load contacts
                const { data: contacts, error } = await supabase
                    .from('contacts')
                    .select('*')
                    .order('priority', { ascending: false });

                if (error) throw error;
                allContacts = contacts || [];

                // Update stats
                updateStats(allContacts);

                // Populate pipeline
                renderPipeline(allContacts);

                // Populate contact dropdown
                populateContactDropdown(allContacts);

                // Load tasks
                await loadTasks();

                // Load recent activity
                await loadRecentActivity();

            } catch (e) {
                console.error('Dashboard load error:', e);
            }
        }

        function updateStats(contacts) {
            const total = contacts.length;
            const pipeline = contacts.reduce((sum, c) => sum + (parseFloat(c.estimated_amount) || 0), 0);

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pipeline').textContent = '$' + (pipeline / 1000000).toFixed(1) + 'M';

            // Calculate stale (no update in 14 days)
            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            const stale = contacts.filter(c => {
                const updated = new Date(c.updated_at);
                return updated < twoWeeksAgo && c.status !== 'committed';
            }).length;
            document.getElementById('stat-stale').textContent = stale;
        }

        function renderPipeline(contacts) {
            const stages = ['prospect', 'contacted', 'meeting', 'proposal', 'committed'];

            stages.forEach(stage => {
                const stageContacts = contacts.filter(c => c.status === stage);
                const container = document.getElementById(`cards-${stage}`);
                const countEl = document.getElementById(`count-${stage}`);
                const valueEl = document.getElementById(`value-${stage}`);

                countEl.textContent = stageContacts.length;
                const totalValue = stageContacts.reduce((sum, c) => sum + (parseFloat(c.estimated_amount) || 0), 0);
                valueEl.textContent = '$' + totalValue.toLocaleString();

                container.innerHTML = stageContacts.slice(0, 10).map(c => `
                    <div class="pipeline-card" draggable="true" data-id="${c.id}" onclick="openContactDetail('${c.id}')">
                        <div class="card-name">${c.name}</div>
                        <div class="card-org">${c.organization || ''}</div>
                        <div class="card-amount">$${(parseFloat(c.estimated_amount) || 0).toLocaleString()}</div>
                        ${c.priority >= 4 ? '<span class="priority-badge">‚òÖ</span>' : ''}
                    </div>
                `).join('');

                if (stageContacts.length > 10) {
                    container.innerHTML += `<div class="more-indicator">+${stageContacts.length - 10} more</div>`;
                }
            });
        }

        function populateContactDropdown(contacts) {
            // No longer using dropdown - using autocomplete instead
            // Keep contacts in allContacts for autocomplete
        }

        // Autocomplete functionality
        let isNewContact = false;
        let selectedContactId = null;

        function setupAutocomplete() {
            const input = document.getElementById('contact-input');
            const dropdown = document.getElementById('contact-dropdown');
            const hiddenId = document.getElementById('contact-id-hidden');
            const newContactFields = document.getElementById('new-contact-fields');
            const statusGroup = document.getElementById('status-update-group');
            const submitBtn = document.getElementById('log-submit-btn');

            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                hiddenId.value = '';
                selectedContactId = null;

                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    newContactFields.style.display = 'none';
                    statusGroup.style.display = 'block';
                    isNewContact = false;
                    submitBtn.textContent = 'Log Interaction';
                    return;
                }

                // Filter contacts
                const matches = allContacts.filter(c =>
                    c.name.toLowerCase().includes(query) ||
                    (c.organization && c.organization.toLowerCase().includes(query)) ||
                    (c.email && c.email.toLowerCase().includes(query)) ||
                    (c.twitter && c.twitter.toLowerCase().includes(query))
                ).slice(0, 6);

                if (matches.length > 0) {
                    dropdown.innerHTML = matches.map(c => `
                        <div class="autocomplete-item" data-id="${c.id}" data-name="${c.name}">
                            <div class="ac-name">${highlightMatch(c.name, query)}</div>
                            <div class="ac-org">${c.organization || c.category || 'Individual'}</div>
                        </div>
                    `).join('') + `
                        <div class="autocomplete-item new-contact" data-id="new">
                            <div class="ac-name">+ Add "${e.target.value}" as new contact</div>
                        </div>
                    `;
                    dropdown.style.display = 'block';
                } else {
                    dropdown.innerHTML = `
                        <div class="autocomplete-item new-contact" data-id="new">
                            <div class="ac-name">+ Add "${e.target.value}" as new contact</div>
                        </div>
                    `;
                    dropdown.style.display = 'block';
                }
            });

            // Handle dropdown item click
            dropdown.addEventListener('click', (e) => {
                const item = e.target.closest('.autocomplete-item');
                if (!item) return;

                const id = item.dataset.id;

                if (id === 'new') {
                    // Creating new contact
                    isNewContact = true;
                    selectedContactId = null;
                    hiddenId.value = '';
                    newContactFields.style.display = 'block';
                    statusGroup.style.display = 'none'; // Hide status for new contacts (they start as 'contacted')
                    submitBtn.textContent = 'Create Contact & Log';
                } else {
                    // Selected existing contact
                    isNewContact = false;
                    selectedContactId = id;
                    hiddenId.value = id;
                    input.value = item.dataset.name;
                    newContactFields.style.display = 'none';
                    statusGroup.style.display = 'block';
                    submitBtn.textContent = 'Log Interaction';
                }

                dropdown.style.display = 'none';
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-wrapper')) {
                    dropdown.style.display = 'none';
                }
            });

            // Handle keyboard navigation
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function showInfo(field) {
            const tooltip = document.getElementById(`info-${field}`);
            if (tooltip) {
                tooltip.classList.toggle('visible');
                // Hide after 5 seconds
                if (tooltip.classList.contains('visible')) {
                    setTimeout(() => tooltip.classList.remove('visible'), 5000);
                }
            }
        }

        async function loadTasks() {
            try {
                const { data: tasks, error } = await supabase
                    .from('follow_ups')
                    .select('*, contacts(name)')
                    .eq('completed', false)
                    .lte('due_date', new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])
                    .order('due_date', { ascending: true });

                if (error) throw error;

                const container = document.getElementById('today-tasks');
                document.getElementById('stat-tasks').textContent = tasks?.length || 0;

                if (!tasks || tasks.length === 0) {
                    container.innerHTML = '<p class="empty-state">No tasks due this week. Great job!</p>';
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                container.innerHTML = tasks.map(t => {
                    const isOverdue = t.due_date < today;
                    const isToday = t.due_date === today;
                    return `
                        <div class="task-item ${isOverdue ? 'overdue' : ''} ${isToday ? 'today' : ''}">
                            <div class="task-checkbox">
                                <input type="checkbox" onchange="completeTask('${t.id}')" title="Mark complete">
                            </div>
                            <div class="task-content">
                                <div class="task-title">${t.task}</div>
                                <div class="task-contact">${t.contacts?.name || 'Unknown'}</div>
                            </div>
                            <div class="task-date ${isOverdue ? 'text-danger' : ''}">${formatDate(t.due_date)}</div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Tasks load error:', e);
            }
        }

        async function loadRecentActivity() {
            try {
                const { data: interactions, error } = await supabase
                    .from('interactions')
                    .select('*, contacts(name)')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const container = document.getElementById('recent-activity');

                if (!interactions || interactions.length === 0) {
                    container.innerHTML = '<p class="empty-state">No activity logged yet. Start by logging an interaction!</p>';
                    return;
                }

                container.innerHTML = interactions.map(i => `
                    <div class="activity-item">
                        <div class="activity-icon ${i.type}">${getActivityIcon(i.type)}</div>
                        <div class="activity-content">
                            <div class="activity-title">
                                <strong>${i.contacts?.name || 'Unknown'}</strong> - ${i.type}
                                ${i.outcome ? `<span class="outcome-badge ${i.outcome}">${i.outcome}</span>` : ''}
                            </div>
                            ${i.notes ? `<div class="activity-notes">${i.notes}</div>` : ''}
                        </div>
                        <div class="activity-time">${formatRelativeTime(i.created_at)}</div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Activity load error:', e);
            }
        }

        function getActivityIcon(type) {
            const icons = {
                email: '‚úâ',
                call: '‚òé',
                meeting: 'üë•',
                social: 'üí¨',
                note: 'üìù',
                donation: 'üí∞'
            };
            return icons[type] || '‚Ä¢';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (dateStr === today.toISOString().split('T')[0]) return 'Today';
            if (dateStr === tomorrow.toISOString().split('T')[0]) return 'Tomorrow';
            if (dateStr < today.toISOString().split('T')[0]) return 'Overdue';

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatRelativeTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Modal functions
        function openQuickLog() {
            document.getElementById('quick-log-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function openContactDetail(id) {
            currentContactId = id;
            const contact = allContacts.find(c => c.id === id);
            if (!contact) return;

            document.getElementById('detail-name').textContent = contact.name;
            document.getElementById('detail-org').textContent = contact.organization || '';
            document.getElementById('detail-amount').textContent = '$' + (parseFloat(contact.estimated_amount) || 0).toLocaleString();
            document.getElementById('detail-hook').innerHTML = contact.hook ? `<strong>Hook:</strong> ${contact.hook}` : '';
            document.getElementById('detail-approach').innerHTML = contact.approach ? `<strong>Approach:</strong> ${contact.approach}` : '';

            // Build links
            let links = [];
            if (contact.twitter) links.push(`<a href="https://twitter.com/${contact.twitter.replace('@', '')}" target="_blank">${contact.twitter}</a>`);
            if (contact.email) links.push(`<a href="mailto:${contact.email}">${contact.email}</a>`);
            if (contact.linkedin) links.push(`<a href="${contact.linkedin}" target="_blank">LinkedIn</a>`);
            if (contact.website) links.push(`<a href="${contact.website}" target="_blank">Website</a>`);
            document.getElementById('detail-links').innerHTML = links.join(' ‚Ä¢ ');

            // Load timeline
            await loadContactTimeline(id);

            document.getElementById('contact-detail-modal').classList.add('active');
        }

        async function loadContactTimeline(contactId) {
            try {
                const { data: interactions, error } = await supabase
                    .from('interactions')
                    .select('*')
                    .eq('contact_id', contactId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('detail-timeline-content');

                if (!interactions || interactions.length === 0) {
                    container.innerHTML = '<p class="empty-state">No interactions logged yet. Log your first interaction!</p>';
                    return;
                }

                container.innerHTML = interactions.map(i => `
                    <div class="timeline-item">
                        <div class="timeline-icon ${i.type}">${getActivityIcon(i.type)}</div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-type">${i.type}</span>
                                ${i.outcome ? `<span class="outcome-badge ${i.outcome}">${i.outcome}</span>` : ''}
                                <span class="timeline-date">${new Date(i.created_at).toLocaleDateString()}</span>
                            </div>
                            ${i.notes ? `<div class="timeline-notes">${i.notes}</div>` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Timeline load error:', e);
            }
        }

        function logInteractionFor(contactId) {
            closeModal('contact-detail-modal');
            const contact = allContacts.find(c => c.id === contactId);
            if (contact) {
                document.getElementById('contact-input').value = contact.name;
                document.getElementById('contact-id-hidden').value = contactId;
                selectedContactId = contactId;
                isNewContact = false;
            }
            openQuickLog();
        }

        async function createFollowupFor(contactId) {
            const task = prompt('What needs to be done?');
            if (!task) return;

            const daysOut = prompt('Due in how many days? (default: 3)', '3');
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + parseInt(daysOut || 3));

            try {
                await supabase.from('follow_ups').insert([{
                    contact_id: contactId,
                    task: task,
                    due_date: dueDate.toISOString().split('T')[0],
                    priority: 3
                }]);

                alert('Follow-up created!');
                await loadTasks();
            } catch (e) {
                console.error('Follow-up creation error:', e);
            }
        }

        async function completeTask(taskId) {
            try {
                await supabase
                    .from('follow_ups')
                    .update({ completed: true, completed_at: new Date().toISOString() })
                    .eq('id', taskId);

                await loadTasks();
            } catch (e) {
                console.error('Task completion error:', e);
            }
        }

        function setupEventListeners() {
            // Setup autocomplete
            setupAutocomplete();

            // Follow-up checkbox toggle
            document.getElementById('create-followup').addEventListener('change', (e) => {
                document.querySelector('.followup-fields').style.display = e.target.checked ? 'block' : 'none';
            });

            // Quick log form submit
            document.getElementById('quick-log-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                let contactId = formData.get('contact_id');
                const contactName = formData.get('contact_name').trim();

                if (!contactName) {
                    alert('Please enter a contact name');
                    return;
                }

                try {
                    // If creating new contact
                    if (isNewContact || !contactId) {
                        // Check if contact already exists by name
                        const existingContact = allContacts.find(c =>
                            c.name.toLowerCase() === contactName.toLowerCase()
                        );

                        if (existingContact) {
                            contactId = existingContact.id;
                        } else {
                            // Create new contact
                            const { data: newContact, error: createError } = await supabase
                                .from('contacts')
                                .insert([{
                                    name: contactName,
                                    email: formData.get('new_email') || null,
                                    twitter: formData.get('new_twitter') || null,
                                    organization: formData.get('new_organization') || null,
                                    category: formData.get('new_category') || 'individual',
                                    estimated_amount: parseFloat(formData.get('new_capacity')) || 5000,
                                    status: 'contacted', // New contacts start as contacted
                                    priority: 3
                                }])
                                .select()
                                .single();

                            if (createError) throw createError;
                            contactId = newContact.id;

                            // Add to local cache
                            allContacts.push(newContact);
                        }
                    }

                    // Log interaction
                    await supabase.from('interactions').insert([{
                        contact_id: contactId,
                        type: formData.get('type'),
                        outcome: formData.get('outcome'),
                        notes: formData.get('notes')
                    }]);

                    // Update status if requested (only for existing contacts)
                    if (!isNewContact) {
                        const newStatus = formData.get('new_status');
                        if (newStatus) {
                            await supabase
                                .from('contacts')
                                .update({ status: newStatus, updated_at: new Date().toISOString() })
                                .eq('id', contactId);
                        } else {
                            // Just update the timestamp
                            await supabase
                                .from('contacts')
                                .update({ updated_at: new Date().toISOString() })
                                .eq('id', contactId);
                        }
                    }

                    // Create follow-up if requested
                    if (formData.get('create_followup')) {
                        const dueDate = new Date();
                        dueDate.setDate(dueDate.getDate() + parseInt(formData.get('followup_days')));

                        await supabase.from('follow_ups').insert([{
                            contact_id: contactId,
                            task: `Follow up on ${formData.get('type')}`,
                            due_date: dueDate.toISOString().split('T')[0],
                            priority: 3
                        }]);
                    }

                    // Reset form and state
                    form.reset();
                    isNewContact = false;
                    selectedContactId = null;
                    document.getElementById('new-contact-fields').style.display = 'none';
                    document.getElementById('status-update-group').style.display = 'block';
                    document.getElementById('log-submit-btn').textContent = 'Log Interaction';

                    closeModal('quick-log-modal');
                    await loadDashboard();

                    const action = isNewContact ? 'Contact created & interaction logged!' : 'Interaction logged!';
                    // Show success toast instead of alert
                    showToast(action);

                } catch (e) {
                    console.error('Log interaction error:', e);
                    alert('Error: ' + e.message);
                }
            });

            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('visible'), 10);
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }
    </script>

    <style>
        .highlight-link {
            color: var(--accent-rust) !important;
            font-weight: 600 !important;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-value {
            display: block;
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent-rust);
        }
        .stat-label {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Pipeline Board */
        .pipeline-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        .pipeline-column {
            background: var(--bg-warm);
            border-radius: 8px;
            padding: 12px;
            min-height: 400px;
        }
        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .column-header h3 {
            font-size: 0.9rem;
            margin: 0;
            color: var(--text-primary);
        }
        .column-count {
            background: var(--accent-rust);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-family: 'Inter', sans-serif;
        }
        .column-value {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        .pipeline-card {
            background: var(--bg-white);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .pipeline-card:hover {
            border-color: var(--accent-rust);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        .card-org {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 2px 0;
        }
        .card-amount {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: var(--accent-rust);
            font-weight: 600;
        }
        .priority-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            color: var(--accent-gold);
            font-size: 0.8rem;
        }
        .more-indicator {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            padding: 8px;
        }

        /* Tasks */
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }
        .task-item:last-child {
            border-bottom: none;
        }
        .task-item.overdue {
            background: #fff5f5;
        }
        .task-item.today {
            background: #fffbf0;
        }
        .task-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .task-content {
            flex: 1;
        }
        .task-title {
            font-weight: 500;
            color: var(--text-primary);
        }
        .task-contact {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .task-date {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .text-danger {
            color: #dc3545 !important;
            font-weight: 600;
        }

        /* Activity */
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-warm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .activity-content {
            flex: 1;
        }
        .activity-title {
            color: var(--text-primary);
        }
        .activity-notes {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .activity-time {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .outcome-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-family: 'Inter', sans-serif;
        }
        .outcome-badge.positive { background: #d4edda; color: #155724; }
        .outcome-badge.neutral { background: #e2e3e5; color: #383d41; }
        .outcome-badge.pending { background: #fff3cd; color: #856404; }
        .outcome-badge.negative { background: #f8d7da; color: #721c24; }

        /* Modals */
        .modal-large {
            max-width: 900px;
            width: 90%;
        }
        .contact-detail-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
        }
        .detail-sidebar {
            border-right: 1px solid var(--border);
            padding-right: 24px;
        }
        .detail-org {
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .detail-amount {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 1.5rem;
            color: var(--accent-rust);
            font-weight: 600;
        }
        .detail-links {
            margin-top: 12px;
            font-size: 0.85rem;
        }
        .detail-links a {
            color: var(--accent-rust);
        }
        .detail-hook, .detail-approach {
            background: var(--bg-warm);
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .detail-actions {
            margin-top: 20px;
        }
        .btn-block {
            width: 100%;
            margin-bottom: 8px;
        }
        .detail-timeline h3 {
            margin-bottom: 16px;
        }

        /* Timeline */
        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .timeline-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-warm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .timeline-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .timeline-type {
            font-weight: 500;
            text-transform: capitalize;
        }
        .timeline-date {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
        }
        .timeline-notes {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Form styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Autocomplete */
        .autocomplete-wrapper {
            position: relative;
        }
        .autocomplete-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-height: 280px;
            overflow-y: auto;
        }
        .autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item:hover {
            background: var(--bg-warm);
        }
        .autocomplete-item.new-contact {
            background: #f0f9ff;
            color: var(--accent-rust);
        }
        .autocomplete-item.new-contact:hover {
            background: #e0f2fe;
        }
        .ac-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .ac-name mark {
            background: #fef3c7;
            padding: 0 2px;
            border-radius: 2px;
        }
        .ac-org {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Info buttons and tooltips */
        .info-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bg-warm);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: 6px;
            vertical-align: middle;
        }
        .info-btn:hover {
            background: var(--accent-rust);
            color: white;
            border-color: var(--accent-rust);
        }
        .info-tooltip {
            display: none;
            background: #1f2937;
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            line-height: 1.5;
            margin-top: 8px;
        }
        .info-tooltip.visible {
            display: block;
        }
        .info-tooltip strong {
            color: #fcd34d;
        }

        /* New contact banner */
        .new-contact-banner {
            background: linear-gradient(90deg, #f0f9ff, #e0f2fe);
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 10px 14px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #0369a1;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 24px;
        }
        .loading {
            text-align: center;
            color: var(--text-muted);
            padding: 24px;
        }

        @media (max-width: 1200px) {
            .pipeline-board {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .pipeline-board {
                grid-template-columns: repeat(2, 1fr);
            }
            .contact-detail-content {
                grid-template-columns: 1fr;
            }
            .detail-sidebar {
                border-right: none;
                padding-right: 0;
                border-bottom: 1px solid var(--border);
                padding-bottom: 20px;
            }
        }
    </style>
</body>
</html>
