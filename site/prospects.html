<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospect Database - AWT Playbook</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <style>
        .protected-content { display: none; }
        .protected-content.unlocked { display: block; }
        .sidebar.unlocked, .content.unlocked { display: flex; }
        .content.unlocked { display: block; }
    </style>

    <!-- Password Protection Overlay -->
    <div id="password-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-paper); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: var(--bg-white); padding: 40px; border-radius: 12px; text-align: center; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <h2 style="margin-bottom: 8px;">Protected Page</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Enter password to access Prospect Tracker</p>
            <input type="password" id="page-password" placeholder="Password" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin-bottom: 12px;" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()" style="width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">Enter</button>
            <p id="password-error" style="color: var(--danger); margin-top: 12px; display: none;">Incorrect password</p>
        </div>
    </div>
    <script>
        function checkPassword() {
            const pwd = document.getElementById('page-password').value;
            if (pwd === '11235813') {
                unlockPage();
            } else {
                document.getElementById('password-error').style.display = 'block';
            }
        }
        function unlockPage() {
            document.getElementById('password-overlay').style.display = 'none';
            document.querySelectorAll('.protected-content').forEach(el => el.classList.add('unlocked'));
            sessionStorage.setItem('awt-prospects-auth', 'true');
        }
        if (sessionStorage.getItem('awt-prospects-auth') === 'true') {
            unlockPage();
        }
    </script>

    <button class="mobile-menu-toggle protected-content" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="sidebar-overlay protected-content"></div>
    <nav class="sidebar protected-content">
        <div class="logo">
            <h2>AWT Playbook</h2>
            <p class="tagline">Fundraising Campaign</p>
        </div>
                <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="crm.html" class="highlight-link">CRM</a></li>
            <li><a href="campaign.html">Campaign</a></li>
            <li><a href="quickstart.html">Start Tonight</a></li>
            <li><a href="socials.html">Social Media</a></li>
            <li><a href="contacts.html">Contact Database</a></li>
            <li><a href="prospects.html">Prospect Tracker</a></li>
            <li><a href="foundations.html">Foundations</a></li>
            <li><a href="corporate.html">Corporate</a></li>
            <li><a href="templates.html">Email Templates</a></li>
            <li><a href="strategy.html">Strategy</a></li>
            <li><a href="resources.html">Resources</a></li>
            <li><a href="deck.html">Pitch Deck</a></li>
            <li><a href="ambassador-onboarding.html">Ambassador Guide</a></li>
        </ul>

        <div class="campaign-goal">
            <h4>Campaign Goal</h4>
            <div class="progress-bar">
                <div class="progress" style="width: 0%"></div>
            </div>
            <p class="goal-text">$0 / $500,000</p>
        </div>
    </nav>

    <main class="content protected-content">
        <header class="page-header">
            <h1>Prospect Database</h1>
            <p class="subtitle">View all contacts in table format. Use <a href="crm.html" style="color: var(--accent-rust);">CRM</a> for pipeline view & interaction tracking.</p>
        </header>

        <!-- CRM Setup Banner -->
        <div id="setup-banner" class="card" style="display: none; background: var(--bg-warm); border-left: 4px solid var(--accent-rust); margin-bottom: 20px;">
            <h3 style="color: var(--accent-rust);">Supabase CRM Setup Required</h3>
            <p style="margin: 12px 0;">To enable cloud-based prospect tracking, run the SQL schema in your Supabase dashboard:</p>
            <ol style="margin-left: 20px; color: var(--text-secondary);">
                <li>Go to <a href="https://supabase.com/dashboard/project/jmivthevbgxfnetmgjca/sql" target="_blank" style="color: var(--accent-rust);">Supabase SQL Editor</a></li>
                <li>Copy the contents of <code>setup-database.sql</code></li>
                <li>Paste and run the SQL</li>
                <li>Refresh this page</li>
            </ol>
            <p style="margin-top: 12px;"><strong>Note:</strong> Until setup is complete, prospects are saved to your browser's local storage.</p>
        </div>

        <div class="search-box">
            <input type="text" class="form-input" placeholder="Search prospects by name, organization, or category..." id="prospect-search">
            <select class="form-select" style="width: auto;" id="filter-category">
                <option value="">All Categories</option>
                <option value="individual">Individual Donors</option>
                <option value="foundation">Foundations</option>
                <option value="corporate">Corporate</option>
                <option value="academic">Academic</option>
            </select>
            <select class="form-select" style="width: auto;" id="filter-stage">
                <option value="">All Stages</option>
                <option value="identified">Identified</option>
                <option value="qualified">Qualified</option>
                <option value="cultivated">Cultivated</option>
                <option value="solicited">Solicited</option>
                <option value="pledged">Pledged</option>
            </select>
            <button class="btn btn-primary" onclick="openAddProspect()">+ Add Prospect</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('all')">All Prospects</button>
            <button class="tab" onclick="showTab('individuals')">Individuals</button>
            <button class="tab" onclick="showTab('foundations')">Foundations</button>
            <button class="tab" onclick="showTab('corporate')">Corporate</button>
        </div>

        <div class="card">
            <table class="data-table" id="prospects-table">
                <thead>
                    <tr>
                        <th>Name / Organization</th>
                        <th>Category</th>
                        <th>Contact</th>
                        <th>Capacity</th>
                        <th>Stage</th>
                        <th>Last Contact</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="prospects-body">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <section class="card mt-20">
            <h3>Prospect Research Resources</h3>
            <p class="text-muted" style="margin: 12px 0;">Use these tools to research and find contact information for prospects:</p>
            <div class="action-grid" style="grid-template-columns: repeat(3, 1fr);">
                <a href="https://candid.org/find-funding" target="_blank" class="action-card">
                    <h4>Foundation Directory Online</h4>
                    <p class="text-muted">Search foundations by focus area</p>
                </a>
                <a href="https://www.linkedin.com/sales/ssi" target="_blank" class="action-card">
                    <h4>LinkedIn</h4>
                    <p class="text-muted">Find decision makers at organizations</p>
                </a>
                <a href="https://projects.propublica.org/nonprofits/" target="_blank" class="action-card">
                    <h4>ProPublica Nonprofit Explorer</h4>
                    <p class="text-muted">View 990s and giving patterns</p>
                </a>
            </div>
        </section>
    </main>

    <!-- Add Prospect Modal -->
    <div class="modal-overlay" id="add-prospect-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Add New Prospect</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="add-prospect-form">
                <div class="form-group">
                    <label>Name / Organization</label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select class="form-select" name="category" required>
                        <option value="individual">Individual Donor</option>
                        <option value="foundation">Foundation</option>
                        <option value="corporate">Corporate</option>
                        <option value="academic">Academic</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Contact Name</label>
                    <input type="text" class="form-input" name="contact_name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-input" name="email">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-group">
                    <label>Estimated Capacity</label>
                    <select class="form-select" name="capacity">
                        <option value="$1K-$5K">$1K - $5K</option>
                        <option value="$5K-$10K">$5K - $10K</option>
                        <option value="$10K-$25K">$10K - $25K</option>
                        <option value="$25K-$50K">$25K - $50K</option>
                        <option value="$50K-$100K">$50K - $100K</option>
                        <option value="$100K+">$100K+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Connection to Mission</label>
                    <textarea class="form-textarea" name="connection" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea class="form-textarea" name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Prospect</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="app.js"></script>
    <script>
        let crmReady = false;
        let allProspects = [];
        let currentFilter = 'all';

        // Check if Supabase tables exist
        async function checkCRMStatus() {
            try {
                const { data, error } = await supabase.from('contacts').select('id').limit(1);
                if (error && error.code === '42P01') {
                    showSetupBanner();
                    return false;
                }
                crmReady = true;
                hideSetupBanner();
                await loadProspects();
                return true;
            } catch (e) {
                console.log('CRM check failed:', e);
                showSetupBanner();
                return false;
            }
        }

        function showSetupBanner() {
            const banner = document.getElementById('setup-banner');
            if (banner) banner.style.display = 'block';
        }

        function hideSetupBanner() {
            const banner = document.getElementById('setup-banner');
            if (banner) banner.style.display = 'none';
        }

        async function loadProspects() {
            if (!crmReady) return;

            // Fetch all contacts
            const { data: prospects, error } = await supabase
                .from('contacts')
                .select('*')
                .order('priority', { ascending: false });

            if (error) {
                console.error('Error loading prospects:', error);
                return;
            }

            allProspects = prospects || [];

            // Also fetch last interaction date for each contact
            const { data: interactions } = await supabase
                .from('interactions')
                .select('contact_id, created_at')
                .order('created_at', { ascending: false });

            // Create a map of contact_id -> last interaction date
            const lastInteractionMap = {};
            if (interactions) {
                interactions.forEach(i => {
                    if (!lastInteractionMap[i.contact_id]) {
                        lastInteractionMap[i.contact_id] = i.created_at;
                    }
                });
            }

            // Add last interaction to each prospect
            allProspects.forEach(p => {
                p.last_interaction = lastInteractionMap[p.id] || null;
            });

            renderProspects();
        }

        function renderProspects() {
            const tbody = document.getElementById('prospects-body');

            // Filter by current tab
            let filtered = allProspects;
            if (currentFilter !== 'all') {
                const categoryMap = {
                    'individuals': 'individual',
                    'foundations': 'foundation',
                    'corporate': 'corporate'
                };
                const cat = categoryMap[currentFilter] || currentFilter;
                filtered = allProspects.filter(p => p.category === cat);
            }

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentFilter === 'all'
                                ? 'No prospects yet. <a href="#" onclick="openAddProspect(); return false;">Add your first prospect</a>'
                                : `No ${currentFilter} found.`}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(p => `
                <tr data-id="${p.id}">
                    <td>
                        <strong>${p.name}</strong>
                        ${p.organization ? `<br><span class="text-muted">${p.organization}</span>` : ''}
                    </td>
                    <td><span class="badge badge-${getCategoryBadge(p.category)}">${p.category}</span></td>
                    <td>
                        ${p.email ? `<a href="mailto:${p.email}">${p.email}</a>` : ''}
                        ${p.twitter ? `<br><a href="https://twitter.com/${p.twitter.replace('@','')}" target="_blank">${p.twitter}</a>` : ''}
                    </td>
                    <td>$${(p.estimated_amount || 0).toLocaleString()}</td>
                    <td><span class="badge badge-${getStatusBadge(p.status)}">${p.status}</span></td>
                    <td>${p.last_interaction ? new Date(p.last_interaction).toLocaleDateString() : '<span class="text-muted">Never</span>'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editProspect('${p.id}')">Edit</button>
                        <button class="btn btn-sm btn-primary" onclick="logInteraction('${p.id}')">Log</button>
                    </td>
                </tr>
            `).join('');
        }

        function getCategoryBadge(cat) {
            const badges = { individual: 'info', foundation: 'success', corporate: 'warning', academic: 'info' };
            return badges[cat] || 'info';
        }

        function getStatusBadge(status) {
            const badges = { prospect: 'info', contacted: 'warning', meeting: 'warning', proposal: 'success', committed: 'success', received: 'success' };
            return badges[status] || 'info';
        }

        function openAddProspect() {
            document.getElementById('add-prospect-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('add-prospect-modal').classList.remove('active');
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            currentFilter = tab;
            renderProspects();
        }

        // Handle form submission
        document.getElementById('add-prospect-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            const prospect = {
                name: formData.get('name'),
                category: formData.get('category'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                estimated_amount: parseCapacity(formData.get('capacity')),
                hook: formData.get('connection'),
                notes: formData.get('notes'),
                status: 'prospect'
            };

            if (crmReady) {
                await AWTCRM.addContact(prospect);
                await loadProspects();
            } else {
                const prospects = JSON.parse(localStorage.getItem('awt_prospects') || '[]');
                prospects.push({ ...prospect, id: Date.now(), created_at: new Date().toISOString() });
                localStorage.setItem('awt_prospects', JSON.stringify(prospects));
            }

            form.reset();
            closeModal();
        });

        function parseCapacity(cap) {
            const map = {
                '$1K-$5K': 3000,
                '$5K-$10K': 7500,
                '$10K-$25K': 17500,
                '$25K-$50K': 37500,
                '$50K-$100K': 75000,
                '$100K+': 100000
            };
            return map[cap] || 0;
        }

        function editProspect(id) {
            // Redirect to CRM with contact detail open
            window.location.href = `crm.html?contact=${id}`;
        }

        function logInteraction(id) {
            // Redirect to CRM with log modal open
            window.location.href = `crm.html?log=${id}`;
        }

        // Initialize
        checkCRMStatus();
    </script>
</body>
</html>
